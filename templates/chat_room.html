{% extends "layout.html" %}

{% block title %}
    Home
{% endblock %}

{% block main %}

<div class="container mt-4">
  <div class="row">
    {% if current_user.username == 'cassie_user' %}
    <div class="col-lg-6 col-md-5">
        <div class="card mt-4 p-3 shadow-sm bg-light">
            <h5 class="mb-3">üì∏ Submit Image for Review</h5>
            <form id="imageSubmissionForm">
                <div class="mb-3">
                    <label for="imageUpload" class="form-label">Select Image</label>
                    <input class="form-control" type="file" id="imageUpload" accept="image/*" required>
                </div>
                <div class="mb-3">
                    <label for="imageDescription" class="form-label">Description</label>
                    <textarea class="form-control" id="imageDescription" rows="3" placeholder="Enter a brief description for the image..." required></textarea>
                </div>
                <button type="submit" class="btn btn-primary w-100">Submit Image</button>
                <div id="imageSubmitStatus" class="mt-2 text-center" style="display:none;"></div>
            </form>
        </div>
        <div class="card mt-4 p-3 shadow-sm bg-light">
            <h5 class="mb-3">Previous Submissions</h5>
            <div id="cassiePreviousSubmissions" class="list-group">
                <p class="text-muted">Loading submissions...</p>
            </div>
        </div>
    </div>
    {% elif current_user.username in ['h', 'olivia'] %}
    <div class="col-lg-6 col-md-5">
        <div class="card mt-4 p-3 shadow-sm bg-light">
            <h5 class="mb-3">üñºÔ∏è Image Submissions & Feedback</h5>
            <div id="currentImageSubmission" class="mb-4">
                <h6>Current Submission:</h6>
                <div id="currentImageDetails" class="text-muted">No current submission.</div>
                <div class="mt-3">
                    <h6>Your Feedback:</h6>
                    <textarea class="form-control mb-2" id="feedbackArea" rows="3" placeholder="Enter your feedback here..."></textarea>
                    <button class="btn btn-success btn-sm" id="submitFeedbackBtn">Submit Feedback</button>
                    <span id="feedbackStatus" class="ms-2" style="font-size:0.9em;color:gray;"></span>
                </div>
            </div>
            <hr>
            <h6>Previous Submissions:</h6>
            <div id="previousImageSubmissions" class="list-group">
                <p class="text-muted">Loading submissions...</p>
            </div>
        </div>
        <div class="mb-3 mt-4">
            <a href="https://drive.google.com/drive/folders/1ASJykXi4KothiRkZMkX3_t-uLIjaKAVA?usp=sharing" target="_blank" class="btn btn-info w-100 d-flex align-items-center justify-content-center">
              <i class="fab fa-google-drive me-2"></i> Project in Google Drive
            </a>
        </div>
        <div class="mb-3 mt-4">
            <a href="https://1drv.ms/o/c/b38e66027044da9e/Esu5aFW_rUhFmuPorV0d_fEBuscCJx9TLoiiPXeKNkCJ0g" 
               target="_blank" 
               class="btn w-100 d-flex align-items-center justify-content-center" 
               style="background-color: #8A2BE2; color: white;" 
               onclick="onenoteWarning(event)">
              <i class="fas fa-book me-2"></i> Documentation in OneNote
            </a>
        </div>
      <div class="mb-2">
        <button class="btn btn-secondary w-100" type="button" id="downloadPopoverBtn">
          <i class="bi bi-download me-2"></i> Download Files
        </button>
      </div>
      <div id="downloadPopover" class="modal" tabindex="-1" style="display:none; background:rgba(0,0,0,0.3);">
        <div class="modal-dialog modal-dialog-centered" style="max-width:420px;">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title"><i class="bi bi-download"></i> Download Files</h5>
              <button type="button" class="btn-close" aria-label="Close" onclick="closeDownloadPopover()"></button>
            </div>
            <div class="modal-body p-0">
              <ul class="list-group list-group-flush">
                {% for file in downloads %}
                <li class="list-group-item">
                  <div>
                    <strong>{{ file.display }}</strong><br>
                    <span style="font-size: 0.9em; color: #555;">{{ file.description }}</span>
                  </div>
                  <a href="{{ url_for('download_file', filename=file.filename) }}"
                     class="btn btn-sm btn-primary mt-1 w-100"
                     download>
                    Download
                  </a>
                </li>
                {% endfor %}
              </ul>
            </div>
          </div>
        </div>
      </div>
      <div class="card mt-4 p-3 shadow-sm bg-light">
        <h5 class="mb-3">üìù To-Do List</h5>
        <div id="todo-list" class="mb-2"></div>
        <div class="input-group mb-2">
          <input type="text" id="new-todo" class="form-control" placeholder="Add new task...">
          <button class="btn btn-success" id="add-todo-btn">Add</button>
        </div>
        <button class="btn btn-outline-secondary btn-sm mb-2" id="edit-todo-btn">Edit as text</button>
        <textarea id="edit-todo-area" class="form-control mb-2" style="display:none; min-height:120px"></textarea>
        <button class="btn btn-primary btn-sm mb-2" id="save-todo-btn" style="display:none;">Save Changes</button>
      </div>
      <div class="card mt-4 p-3 shadow-sm bg-light">
        <h5 class="mb-3">üóíÔ∏è Notes</h5>
        <textarea id="notes-area" class="form-control mb-2" style="min-height:120px" placeholder="Write shared notes here..."></textarea>
        <button class="btn btn-primary btn-sm mb-2" id="save-notes-btn">Save Notes</button>
        <span id="notes-status" style="font-size:0.9em;color:gray;"></span>
      </div>
    </div>
    {% else %}
    <div class="col-lg-6 col-md-5">
        <div class="mb-3">
            <a href="https://drive.google.com/drive/folders/1ASJykXi4KothiRkZMkX3_t-uLIjaKAVA?usp=sharing" target="_blank" class="btn btn-info w-100 d-flex align-items-center justify-content-center">
              <i class="fab fa-google-drive me-2"></i> Project in Google Drive
            </a>
        </div>
      <div class="mb-2">
        <button class="btn btn-secondary w-100" type="button" id="downloadPopoverBtn">
          <i class="bi bi-download me-2"></i> Download Files
        </button>
      </div>
      <div id="downloadPopover" class="modal" tabindex="-1" style="display:none; background:rgba(0,0,0,0.3);">
        <div class="modal-dialog modal-dialog-centered" style="max-width:420px;">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title"><i class="bi bi-download"></i> Download Files</h5>
              <button type="button" class="btn-close" aria-label="Close" onclick="closeDownloadPopover()"></button>
            </div>
            <div class="modal-body p-0">
              <ul class="list-group list-group-flush">
                {% for file in downloads %}
                <li class="list-group-item">
                  <div>
                    <strong>{{ file.display }}</strong><br>
                    <span style="font-size: 0.9em; color: #555;">{{ file.description }}</span>
                  </div>
                  <a href="{{ url_for('download_file', filename=file.filename) }}"
                     class="btn btn-sm btn-primary mt-1 w-100"
                     download>
                    Download
                  </a>
                </li>
                {% endfor %}
              </ul>
            </div>
          </div>
        </div>
      </div>
      <div class="card mt-4 p-3 shadow-sm bg-light">
        <h5 class="mb-3">üìù To-Do List</h5>
        <div id="todo-list" class="mb-2"></div>
        <div class="input-group mb-2">
          <input type="text" id="new-todo" class="form-control" placeholder="Add new task...">
          <button class="btn btn-success" id="add-todo-btn">Add</button>
        </div>
        <button class="btn btn-outline-secondary btn-sm mb-2" id="edit-todo-btn">Edit as text</button>
        <textarea id="edit-todo-area" class="form-control mb-2" style="display:none; min-height:120px"></textarea>
        <button class="btn btn-primary btn-sm mb-2" id="save-todo-btn" style="display:none;">Save Changes</button>
      </div>
      <div class="card mt-4 p-3 shadow-sm bg-light">
        <h5 class="mb-3">üóíÔ∏è Notes</h5>
        <textarea id="notes-area" class="form-control mb-2" style="min-height:120px" placeholder="Write shared notes here..."></textarea>
        <button class="btn btn-primary btn-sm mb-2" id="save-notes-btn">Save Notes</button>
        <span id="notes-status" style="font-size:0.9em;color:gray;"></span>
      </div>
    </div>
    {% endif %}

    <div class="{% if current_user.username == 'cassie_user' or current_user.username in ['h', 'olivia'] %}col-lg-6 col-md-7{% else %}col-lg-6 col-md-7{% endif %} col-12">
      <div class="d-flex justify-content-between align-items-center">
        <h3 class="mb-0">Group Chat</h3>
      </div>
      <div class="chat-window mt-4" style="position: relative;">
        <div id="messages" class="message-box border rounded p-3">
          </div>
        <button id="newMessageIndicator" title="New messages below"
                style="display:none; position: absolute; right: -52px; bottom: 24px; z-index: 10; background: transparent; border: none; box-shadow: none;">
          <span class="fs-2 text-danger">
            <i class="bi bi-exclamation-circle-fill"></i>
          </span>
        </button>
        <div class="d-flex align-items-center mt-3">
          <button type="button" class="btn btn-success plus-btn mr-2"
                  title="Add Photo"
                  onclick="document.getElementById('imageInput').click();"
                  style="display: flex; align-items: center; justify-content: center; width: 40px; height: 40px; border-radius: 50%; font-size: 22px;">
            <span style="font-size:28px;line-height:0;">&#43;</span>
          </button>
          <input type="file" id="imageInput" accept="image/*" style="display: none;" onchange="uploadImage(event, '{{ key }}')">
          <form id="sendMessageForm" class="flex-grow-1 d-flex" method="POST">
            <input type="text" name="message" id="messageInput" class="form-control" placeholder="Type message" autocomplete="off">
            <button class="btn btn-primary ml-2" type="submit">Send</button>
          </form>
        </div>
      </div>
      <div id="fullscreenImageModal" style="display:none; position:fixed; z-index:20000; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.85); align-items:center; justify-content:center;">
        <img id="fullscreenImage" src="" alt="Full size" style="max-width:100vw; max-height:100vh; object-fit: contain; image-rendering: pixelated; image-rendering: -moz-crisp-edges; image-rendering: crisp-edges;" />
        <button onclick="closeFullscreenImage()" style="position:absolute; top:32px; right:40px; font-size:2rem; background:transparent; border:none; color:white; z-index:20001;">&times;</button>
      </div>
    </div>
    {% if current_user.username not in ['cassie_user', 'h', 'olivia'] %}
    <div class="col-12 d-md-none mt-4">
      <div class="p-4 h-100 d-flex flex-column justify-content-center align-items-center" style="background: rgba(240,240,240,0.7); border-radius: 16px;">
        <h2>Welcome to the Game Project!</h2>
        <p style="font-size: 1.1rem;">Use laptop for best compatability.</p>
      </div>
    </div>
    {% endif %}

    {% if current_user.username in ['h', 'olivia'] %}
        <div class="mb-3 mt-4">
            <a href="https://api.render.com/deploy/srv-d1j6cbbe5dus73cvcteg?key=VktNu_BHuoc" 
            target="_blank" 
            class="btn btn-warning w-100 d-flex align-items-center justify-content-center" 
            onclick="warningConfirm(event)">
            <i class="fas fa-exclamation-triangle me-2"></i> Not up to date?
            </a>
        </div>
    {% endif %}
  </div>
</div>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

<style>
    .message-box {
        display: flex;
        flex-direction: column;
        gap: 10px;
        height: 300px;
        max-height: 300px;
        overflow-y: auto;
        border: 1px solid #ccc;
        padding: 15px;
        border-radius: 10px;
        background-color: #fff;
    }
    .message-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        margin-bottom: 10px;
        position: relative;
    }
    .timestamp {
        font-size: 12px;
        color: gray;
        margin-bottom: 4px;
        text-align: center;
        width: 100%;
    }
    .message {
        max-width: 60%;
        padding: 10px;
        border-radius: 15px;
        word-wrap: break-word;
        font-size: 16px;
        display: inline-block;
    }
    .sent {
        background-color: #007bff;
        color: white;
        align-self: flex-end;
        border-bottom-right-radius: 0px;
    }
    .received {
        background-color: #f1f1f1;
        color: black;
        align-self: flex-start;
        border-bottom-left-radius: 0px;
    }
    .plus-btn {
        min-width: 40px;
        min-height: 40px;
        max-width: 40px;
        max-height: 40px;
        padding: 0;
        margin-right: 8px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 22px;
    }
    @media (max-width: 576px) {
        .plus-btn {
            width: 36px;
            height: 36px;
            font-size: 18px;
        }
        #newMessageIndicator {
            right: -36px !important;
            bottom: 16px !important;
        }
    }
    .chat-image {
        max-width: 250px;
        max-height: 250px;
        border-radius: 10px;
        margin: 5px 0;
        display: block;
        cursor: pointer;
        transition: box-shadow .25s;
        image-rendering: pixelated;
        image-rendering: -moz-crisp-edges;
        image-rendering: crisp-edges;
    }
    .chat-image:hover {
        box-shadow: 0 4px 24px #2225;
    }
    #fullscreenImageModal {
        display: flex;
    }
    #todo-list div:hover {
        background: #f7f7f7;
        border-radius: 6px;
    }
    #edit-todo-area {
        font-family: monospace;
        font-size: 1em;
    }
    .submission-item {
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 10px;
        margin-bottom: 10px;
        background-color: #f9f9f9;
    }
    .submission-item img {
        max-width: 100%;
        height: auto;
        border-radius: 4px;
        margin-bottom: 8px;
        image-rendering: pixelated;
        image-rendering: -moz-crisp-edges;
        image-rendering: crisp-edges;
        cursor: pointer;
    }
    #fullscreenImage {
        image-rendering: pixelated;
        image-rendering: -moz-crisp-edges;
        image-rendering: crisp-edges;
    }
    /* Modal styles for Download Files */
    .modal { display: none; position: fixed; z-index: 15000; left: 0; top: 0; width: 100vw; height: 100vh; overflow-y:auto; background: rgba(0, 0, 0, 0.3);}
    .modal.show { display: block; }
    .modal-dialog { margin: 2rem auto; }
</style>

<script>
    function warningConfirm(event) {
            event.preventDefault();
            const confirmed = confirm("Are you sure that you want to update the site? Doing this will take 1-2 minutes off my render usage. Please note that doing this will erase all chat messages.");
            if (confirmed) {
                const targetUrl = event.currentTarget.href;
                window.open(targetUrl, '_blank');
            } else {
                console.log("Navigation to reload site cancelled by user.");
            }
        }
    const key = "{{ key }}";
    const messagesContainer = document.getElementById('messages');
    const newMessageIndicator = document.getElementById('newMessageIndicator');
    const currentUser = "{{ current_user.username }}";
    let renderedMessageIds = new Set();

    // Initialize Web Worker
    let messageWorker;
    if (window.Worker) {
        messageWorker = new Worker('/static/worker.js');

        // Listen for messages from the worker
        messageWorker.onmessage = function(event) {
            const data = event.data;
            if (data.type === 'messages') {
                appendNewMessages(data.messages);
            } else if (data.type === 'error') {
                console.error("Worker error:", data.message);
            } else if (data.type === 'status') {
                console.log("Worker status:", data.message);
            }
        };

        // Start polling when the page loads
        messageWorker.postMessage({ command: 'startPolling', key: key, interval: 3000 });

        // Stop polling when the page is closed or navigated away from
        window.addEventListener('beforeunload', () => {
            messageWorker.postMessage({ command: 'stopPolling' });
        });
    } else {
        console.warn("Web Workers are not supported in this browser. Falling back to main thread polling.");
        // Fallback to main thread polling if Web Workers are not supported
        setInterval(fetchMessages, 3000);
    }

    function getMessageId(message) {
        return message.id || message._id || JSON.stringify(message);
    }

    function isAtBottom() {
        const threshold = 40;
        return messagesContainer.scrollHeight - messagesContainer.scrollTop - messagesContainer.clientHeight < threshold;
    }

    function scrollToBottom() {
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    async function fetchMessages(forceScrollBottom = false) {
        try {
            const response = await fetch(`/messages/${key}`);
            const data = await response.json();
            if (response.ok && data.messages) {
                appendNewMessages(data.messages, forceScrollBottom);
            } else {
                console.error("Error fetching messages:", data.error || response.status);
            }
        } catch (error) {
            console.error("Fetch error:", error);
        }
    }
    function onenoteWarning(event) {
        event.preventDefault();
        const userConfirmed = confirm("Make sure that you are in a non-school account when viewing/editing. If you are in a school account, then the school will have access to the OneNote and will be able to edit, and view the document.");
        if (userConfirmed) {
            const targetUrl = event.currentTarget.href;
            window.open(targetUrl, '_blank');
        } else {
            console.log("User cancelled navigation.");
        }
    }
    function formatDate(timestamp) {
        const utcDate = new Date(timestamp);
        const melbourneOffset = (utcDate.getMonth() >= 9 || utcDate.getMonth() <= 2) ? 11 : 10;
        const melbourneTime = new Date(utcDate.getTime() + melbourneOffset * 60 * 60 * 1000);

        const dayOfWeek = melbourneTime.toLocaleString('en-US', { weekday: 'long' });
        const month = melbourneTime.toLocaleString('en-US', { month: 'long' });
        const year = melbourneTime.getFullYear();
        let day = melbourneTime.getDate();
        const suffixes = ["th", "st", "nd", "rd"];
        const v = day % 100;
        const suffix = suffixes[(v - 20) % 10] || suffixes[v] || suffixes[0];

        const hours = melbourneTime.getHours() % 12 || 12;
        const minutes = melbourneTime.getMinutes().toString().padStart(2, '0');
        const seconds = melbourneTime.getSeconds().toString().padStart(2, '0');
        const ampm = melbourneTime.getHours() >= 12 ? 'PM' : 'AM';

        return `${dayOfWeek}, ${month} ${day}${suffix}, ${year} at ${hours}:${minutes}:${seconds} ${ampm}`;
    }

    function appendNewMessages(messages, forceScrollBottom = false) {
        const atBottom = isAtBottom();
        const previousScrollHeight = messagesContainer.scrollHeight;

        let appended = false;

        messages.forEach(message => {
            const msgId = getMessageId(message);
            if (!renderedMessageIds.has(msgId)) {
                renderedMessageIds.add(msgId);
                appended = true;

                const messageContainer = document.createElement('div');
                messageContainer.classList.add('message-container');

                const timestampElement = document.createElement('div');
                timestampElement.classList.add('timestamp');
                timestampElement.textContent = formatDate(message.timestamp);

                const messageElement = document.createElement('div');
                messageElement.classList.add('message', message.username === currentUser ? 'sent' : 'received');

                if (message.image_url) {
                    messageElement.innerHTML = `<span class="username">${message.username} ${message.emoji}</span>:<br>
                        <img src="${message.image_url}" class="chat-image" alt="sent image" onclick="showFullscreenImage('${message.image_url.replace(/'/g, "\\'")}')">`;
                } else {
                    messageElement.innerHTML = `<span class="username">${message.username} ${message.emoji}</span>: <span class="text">${message.message}</span>`;
                }

                messageContainer.appendChild(timestampElement);
                messageContainer.appendChild(messageElement);
                messagesContainer.appendChild(messageContainer);
            }
        });

        // If new messages were appended AND the document is hidden,
        // then notify of unseen messages, regardless of scroll position.
        if (appended && document.visibilityState === 'hidden') {
            notifyUnseenMessage();
        }

        // The logic for the newMessageIndicator itself remains dependent on !atBottom
        if (appended && !atBottom && !forceScrollBottom) {
            newMessageIndicator.style.display = 'block';
        }

        if (forceScrollBottom || (atBottom && appended)) {
            scrollToBottom();
            newMessageIndicator.style.display = 'none';
        } else if (appended) {
            const newScrollHeight = messagesContainer.scrollHeight;
            messagesContainer.scrollTop += (newScrollHeight - previousScrollHeight);
        }
    }

    function clearMessages() {
        messagesContainer.innerHTML = '';
        renderedMessageIds = new Set();
    }

    clearMessages();

    // The polling is now handled by the Web Worker.
    // setInterval(fetchMessages, 3000); // This line is removed.

    document.getElementById('sendMessageForm').addEventListener('submit', async (event) => {
        event.preventDefault();
        const messageInput = document.getElementById('messageInput');
        if (messageInput.value.trim() === '') return;

        try {
            const response = await fetch(`/chat_room/${key}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ message: messageInput.value })
            });

            if (response.ok) {
                messageInput.value = '';
                // Request a fresh fetch from the worker after sending a message
                if (messageWorker) {
                    messageWorker.postMessage({ command: 'startPolling', key: key, interval: 100 }); // Quick refresh
                    setTimeout(() => messageWorker.postMessage({ command: 'startPolling', key: key, interval: 3000 }), 1000); // Resume normal
                } else {
                    fetchMessages(true); // Fallback for no worker
                }
            } else {
                const data = await response.json();
                console.error("Error sending message:", data.error || response.status);
            }
        } catch (error) {
            console.error("Fetch error:", error);
        }
    });

    function uploadImage(event, groupCode) {
        const file = event.target.files[0];
        if (!file) return;
        const formData = new FormData();
        formData.append('image', file);

        fetch(`/IMAGES/${groupCode}/`, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data && data.image_url) {
                fetch(`/chat_room/${groupCode}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: '',
                        image_url: data.image_url
                    })
                }).then(() => {
                    // Request a fresh fetch from the worker after uploading an image
                    if (messageWorker) {
                        messageWorker.postMessage({ command: 'startPolling', key: key, interval: 100 }); // Quick refresh
                        setTimeout(() => messageWorker.postMessage({ command: 'startPolling', key: key, interval: 3000 }), 1000); // Resume normal
                    } else {
                        fetchMessages(true); // Fallback for no worker
                    }
                });
            } else {
                // Use a custom modal or message box instead of alert()
                showCustomAlert('Photo upload failed.');
            }
        })
        .catch(error => {
            // Use a custom modal or message box instead of alert()
            showCustomAlert('Photo upload failed.');
        });
        event.target.value = "";
    }

    newMessageIndicator.addEventListener('click', function() {
        scrollToBottom();
        this.style.display = 'none';
    });

    messagesContainer.addEventListener('scroll', function() {
        if (isAtBottom()) {
            newMessageIndicator.style.display = 'none';
        }
    });

    function showFullscreenImage(src) {
        const modal = document.getElementById('fullscreenImageModal');
        const img = document.getElementById('fullscreenImage');

        img.src = src;
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
    }

    function closeFullscreenImage() {
        document.getElementById('fullscreenImageModal').style.display = 'none';
        document.body.style.overflow = '';
    }

    document.getElementById('fullscreenImageModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeFullscreenImage();
        }
    });

    // Custom Alert/Message Box (replaces alert())
    function showCustomAlert(message) {
        const alertModal = document.createElement('div');
        alertModal.style.cssText = `
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            z-index: 20000; text-align: center; max-width: 300px;
        `;
        alertModal.innerHTML = `
            <p>${message}</p>
            <button onclick="this.parentNode.remove()" style="padding: 8px 15px; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">OK</button>
        `;
        document.body.appendChild(alertModal);
    }

    // Download popover/modal logic
    const downloadPopover = document.getElementById('downloadPopover');
    const downloadPopoverBtn = document.getElementById('downloadPopoverBtn');
    if (downloadPopoverBtn) {
      downloadPopoverBtn.addEventListener('click', function() {
        downloadPopover.classList.add('show');
        downloadPopover.style.display = 'block';
        document.body.style.overflow = 'hidden';
      });
    }
    function closeDownloadPopover() {
      downloadPopover.classList.remove('show');
      downloadPopover.style.display = 'none';
      document.body.style.overflow = '';
    }
    if (downloadPopover) {
      // Click outside modal closes it
      downloadPopover.addEventListener('mousedown', function(e) {
        if (e.target === downloadPopover) closeDownloadPopover();
      });
      // Esc key closes
      document.addEventListener('keydown', function(e) {
        if (downloadPopover.classList.contains('show') && e.key === 'Escape') {
          closeDownloadPopover();
        }
      });
    }

    if (currentUser !== 'cassie_user') {
        let todoList = [];
        const newTodo = document.getElementById('new-todo');
        const addBtn = document.getElementById('add-todo-btn');
        const editBtn = document.getElementById('edit-todo-btn');
        const saveBtn = document.getElementById('save-todo-btn');
        const editArea = document.getElementById('edit-todo-area');
        const todoDiv = document.getElementById('todo-list');

        function renderTodoList(list) {
            const container = document.getElementById('todo-list');
            container.innerHTML = '';
            list.forEach((item, idx) => {
                const div = document.createElement('div');
                div.className = "d-flex align-items-center mb-1";
                div.innerHTML = `
                    <input type="checkbox" ${item.done ? "checked" : ""} style="margin-right:8px;" data-idx="${idx}">
                    <span style="flex:1;${item.done?"text-decoration:line-through; color:#888;":""}">${item.text}</span>
                    <button class="btn btn-danger btn-sm ms-2" data-remove-idx="${idx}" title="Delete">üóëÔ∏è</button>
                `;
                container.appendChild(div);
            });
        }

        async function loadTodoList() {
            const res = await fetch('/todo');
            const list = await res.json();
            renderTodoList(list);
        }
        async function saveTodoList(list) {
            await fetch('/todo', {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({todo: list})
            });
        }

        document.addEventListener("DOMContentLoaded", () => {
            function refresh() {
                loadTodoList().then(() => {
                    fetch('/todo').then(r=>r.json()).then(list => todoList = list);
                });
            }
            refresh();

            addBtn.onclick = async () => {
                if(newTodo.value.trim()) {
                    todoList.push({text: newTodo.value.trim(), done: false});
                    await saveTodoList(todoList);
                    newTodo.value = "";
                    refresh();
                }
            };
            todoDiv.onclick = async (e) => {
                if(e.target.matches('input[type=checkbox]')) {
                    const idx = +e.target.dataset.idx;
                    todoList[idx].done = e.target.checked;
                    await saveTodoList(todoList);
                    refresh();
                } else if(e.target.dataset.removeIdx !== undefined) {
                    const idx = +e.target.dataset.removeIdx;
                    todoList.splice(idx,1);
                    await saveTodoList(todoList);
                    refresh();
                }
            };
            editBtn.onclick = () => {
                editArea.value = todoList.map(t => (t.done?"[x] ":"[ ] ") + t.text).join("\n");
                editArea.style.display = saveBtn.style.display = "block";
                editBtn.style.display = "none";
            };
            saveBtn.onclick = async () => {
                todoList = editArea.value.split(/\n/).filter(Boolean).map(line => {
                    let done = /^\s*\[x\]/i.test(line);
                    let text = line.replace(/^\s*\[[x ]\]\s*/i,"");
                    return {text, done};
                });
                await saveTodoList(todoList);
                editArea.style.display = saveBtn.style.display = "none";
                editBtn.style.display = "inline-block";
                refresh();
            };
        });
    }

    if (currentUser !== 'cassie_user') {
        const notesArea = document.getElementById('notes-area');
        const saveNotesBtn = document.getElementById('save-notes-btn');
        const notesStatus = document.getElementById('notes-status');

        async function loadNotes() {
            const res = await fetch('/notes');
            const notes = await res.json();
            notesArea.value = typeof notes === "string" ? notes : (Array.isArray(notes) ? notes.join('\n') : "");
        }
        loadNotes();

        saveNotesBtn.onclick = async () => {
            const notes = notesArea.value;
            notesStatus.textContent = "Saving...";
            await fetch('/notes', {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({notes: notes})
            });
            notesStatus.textContent = "Saved!";
            setTimeout(() => notesStatus.textContent = "", 1500);
        };
    }

    if (currentUser === 'cassie_user') {
        const imageSubmissionForm = document.getElementById('imageSubmissionForm');
        const imageUploadInput = document.getElementById('imageUpload');
        const imageDescriptionInput = document.getElementById('imageDescription');
        const imageSubmitStatus = document.getElementById('imageSubmitStatus');
        const cassiePreviousSubmissionsDiv = document.getElementById('cassiePreviousSubmissions');

        imageSubmissionForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            
            const file = imageUploadInput.files[0];
            const description = imageDescriptionInput.value.trim();

            if (!file || !description) {
                imageSubmitStatus.textContent = "Please select an image and provide a description.";
                imageSubmitStatus.style.color = "red";
                return;
            }

            imageSubmitStatus.textContent = "Uploading and submitting...";
            imageSubmitStatus.style.color = "blue";

            const formData = new FormData();
            formData.append('image', file);
            formData.append('description', description);

            try {
                const response = await fetch('/submit_image', {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();

                if (response.ok) {
                    imageSubmitStatus.textContent = data.message;
                    imageSubmitStatus.style.color = "green";
                    imageUploadInput.value = '';
                    imageDescriptionInput.value = '';
                    fetchImageSubmissionsForCassie();
                } else {
                    imageSubmitStatus.textContent = `Error: ${data.error || 'Unknown error'}`;
                    imageSubmitStatus.style.color = "red";
                }
            } catch (error) {
                imageSubmitStatus.textContent = `Network error: ${error.message}`;
                imageSubmitStatus.style.color = "red";
                console.error("Image submission fetch error:", error);
            }
            setTimeout(() => imageSubmitStatus.style.display = 'none', 5000);
            imageSubmitStatus.style.display = 'block';
        });

        async function fetchImageSubmissionsForCassie() {
            try {
                const response = await fetch('/get_image_submissions');
                const data = await response.json();
                if (response.ok && data.submissions) {
                    renderCassieSubmissions(data.submissions);
                } else {
                    console.error("Error fetching Cassie's submissions:", data.error || response.status);
                    cassiePreviousSubmissionsDiv.innerHTML = '<p class="text-danger">Failed to load submissions.</p>';
                }
            }
            catch (error) {
                console.error("Fetch error for Cassie's submissions:", error);
                cassiePreviousSubmissionsDiv.innerHTML = '<p class="text-danger">Network error loading submissions.</p>';
            }
        }

        function renderCassieSubmissions(submissions) {
            cassiePreviousSubmissionsDiv.innerHTML = '';
            if (submissions.length === 0) {
                cassiePreviousSubmissionsDiv.innerHTML = '<p class="text-muted">No submissions yet.</p>';
                return;
            }
            submissions.forEach(submission => {
                const submissionDiv = document.createElement('div');
                submissionDiv.classList.add('list-group-item', 'submission-item');
                submissionDiv.innerHTML = `
                    <p class="mb-1"><strong>Description:</strong> ${submission.description}</p>
                    <img src="${submission.image_url}" alt="Submission Image" class="img-fluid mb-2 chat-image" style="cursor:pointer; image-rendering:pixelated;" onclick="location.href='/view_image?id=${submission.id}'">
                    <small class="text-muted d-block mb-2">Submitted: ${formatDate(submission.timestamp)}</small>
                    <div class="submission-feedback">
                        <strong>Feedback:</strong><br>
                        H: ${submission.feedback.h || 'No feedback yet.'}<br>
                        Olivia: ${submission.feedback.olivia || 'No feedback yet.'}
                    </div>
                `;
                cassiePreviousSubmissionsDiv.appendChild(submissionDiv);
            });
        }
        fetchImageSubmissionsForCassie();
        setInterval(fetchImageSubmissionsForCassie, 10000);
    } 
    else if (currentUser === 'h' || currentUser === 'olivia') {
        const currentImageDetailsDiv = document.getElementById('currentImageDetails');
        const feedbackArea = document.getElementById('feedbackArea');
        const submitFeedbackBtn = document.getElementById('submitFeedbackBtn');
        const feedbackStatusSpan = document.getElementById('feedbackStatus');
        const previousImageSubmissionsDiv = document.getElementById('previousImageSubmissions');

        let currentSubmissionId = null;

        submitFeedbackBtn.addEventListener('click', async () => {
            if (!currentSubmissionId) {
                feedbackStatusSpan.textContent = "No current submission to provide feedback for.";
                feedbackStatusSpan.style.color = "red";
                return;
            }
            const feedbackText = feedbackArea.value.trim();
            if (!feedbackText) {
                feedbackStatusSpan.textContent = "Feedback cannot be empty.";
                feedbackStatusSpan.style.color = "red";
                return;
            }

            feedbackStatusSpan.textContent = "Submitting feedback...";
            feedbackStatusSpan.style.color = "blue";

            try {
                const response = await fetch(`/submit_feedback/${currentSubmissionId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ feedback: feedbackText })
                });
                const data = await response.json();

                if (response.ok) {
                    feedbackStatusSpan.textContent = data.message;
                    feedbackStatusSpan.style.color = "green";
                    fetchImageSubmissions();
                } else {
                    feedbackStatusSpan.textContent = `Error: ${data.error || 'Unknown error'}`;
                    feedbackStatusSpan.style.color = "red";
                }
            } catch (error) {
                feedbackStatusSpan.textContent = `Network error: ${error.message}`;
                feedbackStatusSpan.style.color = "red";
                console.error("Feedback submission fetch error:", error);
            }
            setTimeout(() => feedbackStatusSpan.textContent = "", 5000);
        });

        async function fetchImageSubmissions() {
            try {
                const response = await fetch('/get_image_submissions');
                const data = await response.json();
                if (response.ok && data.submissions) {
                    renderImageSubmissions(data.submissions);
                } else {
                    console.error("Error fetching image submissions:", data.error || response.status);
                    currentImageDetailsDiv.innerHTML = '<p class="text-danger">Failed to load submissions.</p>';
                    previousImageSubmissionsDiv.innerHTML = '';
                }
            } catch (error) {
                console.error("Fetch error for image submissions:", error);
                currentImageDetailsDiv.innerHTML = '<p class="text-danger">Network error loading submissions.</p>';
                previousImageSubmissionsDiv.innerHTML = '';
            }
        }

        function renderImageSubmissions(submissions) {
            currentImageDetailsDiv.innerHTML = '';
            previousImageSubmissionsDiv.innerHTML = '';

            if (submissions.length === 0) {
                currentImageDetailsDiv.innerHTML = '<p class="text-muted">No submissions yet.</p>';
                previousImageSubmissionsDiv.innerHTML = '<p class="text-muted">No previous submissions.</p>';
                currentSubmissionId = null;
                feedbackArea.value = '';
                feedbackArea.disabled = true;
                submitFeedbackBtn.disabled = true;
                return;
            }
            const currentSubmission = submissions[0];
            currentSubmissionId = currentSubmission.id;
            feedbackArea.disabled = false;
            submitFeedbackBtn.disabled = false;

            const currentFeedbackValue = feedbackArea.value;
            const hasFeedbackFocus = (document.activeElement === feedbackArea);

            currentImageDetailsDiv.innerHTML = `
                <div class="submission-item">
                    <p class="mb-1"><strong>Description:</strong> ${currentSubmission.description}</p>
                    <img src="${currentSubmission.image_url}" alt="Current Submission Image" class="img-fluid mb-2 chat-image" style="cursor:pointer; image-rendering:pixelated;" onclick="location.href='/view_image?id=${currentSubmission.id}'">
                    <small class="text-muted d-block mb-2">Submitted by ${currentSubmission.uploader} on ${formatDate(currentSubmission.timestamp)}</small>
                    <div class="submission-feedback">
                        H's Feedback: ${currentSubmission.feedback.h || 'No feedback yet.'}<br>
                        Olivia's Feedback: ${currentSubmission.feedback.olivia || 'No feedback yet.'}
                    </div>
                </div>
            `;
            if (!hasFeedbackFocus) {
                feedbackArea.value = currentSubmission.feedback[currentUser] || '';
            }

            if (submissions.length > 1) {
                submissions.slice(1).forEach(submission => {
                    const submissionDiv = document.createElement('div');
                    submissionDiv.classList.add('list-group-item', 'submission-item');
                    submissionDiv.innerHTML = `
                        <p class="mb-1"><strong>Description:</strong> ${submission.description}</p>
                        <img src="${submission.image_url}" alt="Previous Submission Image" class="img-fluid mb-2 chat-image" style="cursor:pointer; image-rendering:pixelated;" onclick="location.href='/view_image?id=${submission.id}'">
                        <small class="text-muted d-block mb-2">Submitted by ${submission.uploader} on ${formatDate(submission.timestamp)}</small>
                        <div class="submission-feedback">
                            H's Feedback: ${submission.feedback.h || 'No feedback yet.'}<br>
                            Olivia's Feedback: ${submission.feedback.olivia || 'No feedback yet.'}
                        </div>
                    `;
                    previousImageSubmissionsDiv.appendChild(submissionDiv);
                });
            } else {
                previousImageSubmissionsDiv.innerHTML = '<p class="text-muted">No previous submissions.</p>';
            }
        }
        fetchImageSubmissions();
        setInterval(fetchImageSubmissions, 10000);
    }
    
    const originalFaviconHref = '/static/favicon.ico';
    const alertFaviconHref = '/static/favicon2.ico';
    const originalTitle = 'Pok√©mon Shine | Home';
    const alertTitle = '!!! Unread messages';
    let hasUnseenMessage = false;

    // Helper to change favicon
    function setFavicon(href) {
        let favicon = document.querySelector("link[rel~='icon']");
        if (!favicon) {
            favicon = document.createElement('link');
            favicon.rel = 'icon';
            document.head.appendChild(favicon);
        }
        favicon.href = href;
    }

    // Reset favicon and title when tab is focused or becomes visible
    window.addEventListener('focus', () => {
        if (hasUnseenMessage) {
            setFavicon(originalFaviconHref);
            document.title = originalTitle;
            hasUnseenMessage = false;
        }
    });

    document.addEventListener('visibilitychange', () => {
        if (document.visibilityState === 'visible' && hasUnseenMessage) {
            setFavicon(originalFaviconHref);
            document.title = originalTitle;
            hasUnseenMessage = false;
        }
    });

    // Detect new unseen messages
    function notifyUnseenMessage() {
        // Only if tab is not visible and we haven't already alerted
        if (document.visibilityState === 'hidden' && !hasUnseenMessage) {
            console.log('Tab is hidden, notifying of unseen message.'); // Debugging log
            setFavicon(alertFaviconHref);
            document.title = alertTitle;
            hasUnseenMessage = true;
        } else {
            console.log('Tab is visible or already notified. visibilityState:', document.visibilityState); // Debugging log
        }
    }

</script>
{% endblock %}
