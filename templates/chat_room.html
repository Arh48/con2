{% extends "layout.html" %}

{% block title %}
    Chat Room
{% endblock %}

{% block main %}
<div class="container mt-4">
  <div class="row">
    <!-- Left column: Conditional content based on username -->
    {% if current_user.username == 'cassie_user' %}
    <div class="col-lg-6 col-md-5">
        <!-- Cassie's Image Submission Form -->
        <div class="card mt-4 p-3 shadow-sm bg-light">
            <h5 class="mb-3">üì∏ Submit Image for Review</h5>
            <form id="imageSubmissionForm">
                <div class="mb-3">
                    <label for="imageUpload" class="form-label">Select Image</label>
                    <input class="form-control" type="file" id="imageUpload" accept="image/*" required>
                </div>
                <div class="mb-3">
                    <label for="imageDescription" class="form-label">Description</label>
                    <textarea class="form-control" id="imageDescription" rows="3" placeholder="Enter a brief description for the image..." required></textarea>
                </div>
                <button type="submit" class="btn btn-primary w-100">Submit Image</button>
                <div id="imageSubmitStatus" class="mt-2 text-center" style="display:none;"></div>
            </form>
        </div>
        <!-- Display previous submissions for Cassie -->
        <div class="card mt-4 p-3 shadow-sm bg-light">
            <h5 class="mb-3">Previous Submissions</h5>
            <div id="cassiePreviousSubmissions" class="list-group">
                <!-- Previous submissions will be loaded here by JS -->
                <p class="text-muted">Loading submissions...</p>
            </div>
        </div>
    </div>
    {% elif current_user.username in ['h', 'olivia'] %}
    <div class="col-lg-6 col-md-5">
        <!-- Image Feedback Section -->
        <div class="card mt-4 p-3 shadow-sm bg-light">
            <h5 class="mb-3">üñºÔ∏è Image Submissions & Feedback</h5>
            <div id="currentImageSubmission" class="mb-4">
                <h6>Current Submission:</h6>
                <div id="currentImageDetails" class="text-muted">No current submission.</div>
                <div class="mt-3">
                    <h6>Your Feedback:</h6>
                    <textarea class="form-control mb-2" id="feedbackArea" rows="3" placeholder="Enter your feedback here..."></textarea>
                    <button class="btn btn-success btn-sm" id="submitFeedbackBtn">Submit Feedback</button>
                    <span id="feedbackStatus" class="ms-2" style="font-size:0.9em;color:gray;"></span>
                </div>
            </div>
            <hr>
            <h6>Previous Submissions:</h6>
            <div id="previousImageSubmissions" class="list-group">
                <!-- Previous submissions will be loaded here by JS -->
                <p class="text-muted">Loading submissions...</p>
            </div>
        </div>

        {# Re-added Downloads, To-Do, and Notes for 'h' and 'olivia' #}
        <div class="mb-3 mt-4">
            <a href="https://drive.google.com/drive/folders/1ASJykXi4KothiRkZMkX3_t-uLIjaKAVA?usp=sharing" target="_blank" class="btn btn-info w-100 d-flex align-items-center justify-content-center">
              <i class="fab fa-google-drive me-2"></i> Project in Google Drive
            </a>
        </div>
      <!-- Downloads Dropdown -->
      <div class="dropdown mb-2">
        <button class="btn btn-secondary dropdown-toggle w-100" type="button" id="downloadDropdown" data-bs-toggle="dropdown" aria-expanded="false">
          Download Files
        </button>
        <ul class="dropdown-menu w-100" aria-labelledby="downloadDropdown">
          {% for file in downloads %}
          <li class="px-3 py-2">
            <div>
              <strong>{{ file.display }}</strong>
              <br>
              <span style="font-size: 0.9em; color: #555;">{{ file.description }}</span>
            </div>
            <a href="{{ url_for('download_file', filename=file.filename) }}" class="btn btn-sm btn-primary mt-1" style="width: 100%;">Download</a>
          </li>
          <li><hr class="dropdown-divider"></li>
          {% endfor %}
        </ul>
      </div>
      <!-- To-Do List -->
      <div class="card mt-4 p-3 shadow-sm bg-light">
        <h5 class="mb-3">üìù To-Do List</h5>
        <div id="todo-list" class="mb-2"></div>
        <div class="input-group mb-2">
          <input type="text" id="new-todo" class="form-control" placeholder="Add new task...">
          <button class="btn btn-success" id="add-todo-btn">Add</button>
        </div>
        <button class="btn btn-outline-secondary btn-sm mb-2" id="edit-todo-btn">Edit as text</button>
        <textarea id="edit-todo-area" class="form-control mb-2" style="display:none; min-height:120px"></textarea>
        <button class="btn btn-primary btn-sm mb-2" id="save-todo-btn" style="display:none;">Save Changes</button>
      </div>
      <!-- Notes -->
      <div class="card mt-4 p-3 shadow-sm bg-light">
        <h5 class="mb-3">üóíÔ∏è Notes</h5>
        <textarea id="notes-area" class="form-control mb-2" style="min-height:120px" placeholder="Write shared notes here..."></textarea>
        <button class="btn btn-primary btn-sm mb-2" id="save-notes-btn">Save Notes</button>
        <span id="notes-status" style="font-size:0.9em;color:gray;"></span>
      </div>
    </div>
    {% else %}
    <!-- Original left column content for other users -->
    <div class="col-lg-6 col-md-5">
        <div class="mb-3">
            <a href="https://drive.google.com/drive/folders/1ASJykXi4KothiRkZMkX3_t-uLIjaKAVA?usp=sharing" target="_blank" class="btn btn-info w-100 d-flex align-items-center justify-content-center">
              <i class="fab fa-google-drive me-2"></i> Project in Google Drive
            </a>
        </div>
      <!-- Downloads Dropdown -->
      <div class="dropdown mb-2">
        <button class="btn btn-secondary dropdown-toggle w-100" type="button" id="downloadDropdown" data-bs-toggle="dropdown" aria-expanded="false">
          Download Files
        </button>
        <ul class="dropdown-menu w-100" aria-labelledby="downloadDropdown">
          {% for file in downloads %}
          <li class="px-3 py-2">
            <div>
              <strong>{{ file.display }}</strong>
              <br>
              <span style="font-size: 0.9em; color: #555;">{{ file.description }}</span>
            </div>
            <a href="{{ url_for('download_file', filename=file.filename) }}" class="btn btn-sm btn-primary mt-1" style="width: 100%;">Download</a>
          </li>
          <li><hr class="dropdown-divider"></li>
          {% endfor %}
        </ul>
      </div>
      <!-- To-Do List -->
      <div class="card mt-4 p-3 shadow-sm bg-light">
        <h5 class="mb-3">üìù To-Do List</h5>
        <div id="todo-list" class="mb-2"></div>
        <div class="input-group mb-2">
          <input type="text" id="new-todo" class="form-control" placeholder="Add new task...">
          <button class="btn btn-success" id="add-todo-btn">Add</button>
        </div>
        <button class="btn btn-outline-secondary btn-sm mb-2" id="edit-todo-btn">Edit as text</button>
        <textarea id="edit-todo-area" class="form-control mb-2" style="display:none; min-height:120px"></textarea>
        <button class="btn btn-primary btn-sm mb-2" id="save-todo-btn" style="display:none;">Save Changes</button>
      </div>
      <!-- Notes -->
      <div class="card mt-4 p-3 shadow-sm bg-light">
        <h5 class="mb-3">üóíÔ∏è Notes</h5>
        <textarea id="notes-area" class="form-control mb-2" style="min-height:120px" placeholder="Write shared notes here..."></textarea>
        <button class="btn btn-primary btn-sm mb-2" id="save-notes-btn">Save Notes</button>
        <span id="notes-status" style="font-size:0.9em;color:gray;"></span>
      </div>
    </div>
    {% endif %}

    <!-- Main chat column -->
    <div class="{% if current_user.username == 'cassie_user' or current_user.username in ['h', 'olivia'] %}col-lg-6 col-md-7{% else %}col-lg-6 col-md-7{% endif %} col-12">
      <div class="d-flex justify-content-between align-items-center">
        <h3 class="mb-0">Group Chat</h3>
      </div>
      <div class="chat-window mt-4" style="position: relative;">
        <div id="messages" class="message-box border rounded p-3">
          <!-- messages will be inserted here -->
        </div>
        <button id="newMessageIndicator" title="New messages below"
                style="display:none; position: absolute; right: -52px; bottom: 24px; z-index: 10; background: transparent; border: none; box-shadow: none;">
          <span class="fs-2 text-danger">
            <i class="bi bi-exclamation-circle-fill"></i>
          </span>
        </button>
        <div class="d-flex align-items-center mt-3">
          <button type="button" class="btn btn-success plus-btn mr-2"
                  title="Add Photo"
                  onclick="document.getElementById('imageInput').click();"
                  style="display: flex; align-items: center; justify-content: center; width: 40px; height: 40px; border-radius: 50%; font-size: 22px;">
            <span style="font-size:28px;line-height:0;">&#43;</span>
          </button>
          <input type="file" id="imageInput" accept="image/*" style="display: none;" onchange="uploadImage(event, '{{ key }}')">
          <form id="sendMessageForm" class="flex-grow-1 d-flex" method="POST">
            <input type="text" name="message" id="messageInput" class="form-control" placeholder="Type message" autocomplete="off">
            <button class="btn btn-primary ml-2" type="submit">Send</button>
          </form>
        </div>
      </div>
      <div id="fullscreenImageModal" style="display:none; position:fixed; z-index:20000; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.85); align-items:center; justify-content:center;">
        <img id="fullscreenImage" src="" alt="Full size" style="max-width:60vw; max-height:60vh; object-fit: contain; image-rendering: pixelated; image-rendering: -moz-crisp-edges; image-rendering: crisp-edges;" />
        <button onclick="closeFullscreenImage()" style="position:absolute; top:32px; right:40px; font-size:2rem; background:transparent; border:none; color:white; z-index:20001;">&times;</button>
      </div>
    </div>
    <!-- Below chat: Info/game for mobile - Conditional visibility -->
    {% if current_user.username not in ['cassie_user', 'h', 'olivia'] %}
    <div class="col-12 d-md-none mt-4">
      <div class="p-4 h-100 d-flex flex-column justify-content-center align-items-center" style="background: rgba(240,240,240,0.7); border-radius: 16px;">
        <h2>Welcome to the Game Project!</h2>
        <p style="font-size: 1.1rem;">Here goes your game, project info, leaderboard, or any homepage content.</p>
      </div>
    </div>
    {% endif %}
  </div>
</div>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

<style>
    .message-box {
        display: flex;
        flex-direction: column;
        gap: 10px;
        height: 300px;
        max-height: 300px;
        overflow-y: auto;
        border: 1px solid #ccc;
        padding: 15px;
        border-radius: 10px;
        background-color: #fff;
    }
    .message-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        margin-bottom: 10px;
        position: relative;
    }
    .timestamp {
        font-size: 12px;
        color: gray;
        margin-bottom: 4px;
        text-align: center;
        width: 100%;
    }
    .message {
        max-width: 60%;
        padding: 10px;
        border-radius: 15px;
        word-wrap: break-word;
        font-size: 16px;
        display: inline-block;
    }
    .sent {
        background-color: #007bff;
        color: white;
        align-self: flex-end;
        border-bottom-right-radius: 0px;
    }
    .received {
        background-color: #f1f1f1;
        color: black;
        align-self: flex-start;
        border-bottom-left-radius: 0px;
    }
    .plus-btn {
        min-width: 40px;
        min-height: 40px;
        max-width: 40px;
        max-height: 40px;
        padding: 0;
        margin-right: 8px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 22px;
    }
    @media (max-width: 576px) {
        .plus-btn {
            width: 36px;
            height: 36px;
            font-size: 18px;
        }
        #newMessageIndicator {
            right: -36px !important;
            bottom: 16px !important;
        }
    }
    .chat-image {
        max-width: 250px; /* Increased size */
        max-height: 250px; /* Increased size */
        border-radius: 10px;
        margin: 5px 0;
        display: block;
        cursor: pointer;
        transition: box-shadow .25s;
        image-rendering: pixelated; /* Pixelated effect */
        image-rendering: -moz-crisp-edges; /* Firefox */
        image-rendering: crisp-edges; /* Standard */
    }
    .chat-image:hover {
        box-shadow: 0 4px 24px #2225;
    }
    #fullscreenImageModal {
        display: flex;
    }
    /* To-Do List extra */
    #todo-list div:hover {
        background: #f7f7f7;
        border-radius: 6px;
    }
    #edit-todo-area {
        font-family: monospace;
        font-size: 1em;
    }
    /* Image Submission/Feedback Specific Styles */
    .submission-item {
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 10px;
        margin-bottom: 10px;
        background-color: #f9f9f9;
    }
    .submission-item img {
        max-width: 100%;
        height: auto;
        border-radius: 4px;
        margin-bottom: 8px;
        image-rendering: pixelated; /* Pixelated effect */
        image-rendering: -moz-crisp-edges; /* Firefox */
        image-rendering: crisp-edges; /* Standard */
    }
    #fullscreenImage {
        /* Removed border-radius and box-shadow from here, moved pixelation to inline style */
        image-rendering: pixelated; /* Pixelated effect */
        image-rendering: -moz-crisp-edges; /* Firefox */
        image-rendering: crisp-edges; /* Standard */
    }
</style>

<script>
    // --- Chat logic ---
    const key = "{{ key }}";
    const messagesContainer = document.getElementById('messages');
    const newMessageIndicator = document.getElementById('newMessageIndicator');
    const currentUser = "{{ current_user.username }}";
    let renderedMessageIds = new Set();

    function getMessageId(message) {
        return message.id || message._id || JSON.stringify(message);
    }

    function isAtBottom() {
        const threshold = 40;
        return messagesContainer.scrollHeight - messagesContainer.scrollTop - messagesContainer.clientHeight < threshold;
    }

    function scrollToBottom() {
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    async function fetchMessages(forceScrollBottom = false) {
        try {
            const response = await fetch(`/messages/${key}`);
            const data = await response.json();
            if (response.ok && data.messages) {
                appendNewMessages(data.messages, forceScrollBottom);
            } else {
                console.error("Error fetching messages:", data.error || response.status);
            }
        } catch (error) {
            console.error("Fetch error:", error);
        }
    }

    function formatDate(timestamp) {
        const utcDate = new Date(timestamp);
        const melbourneOffset = (utcDate.getMonth() >= 9 || utcDate.getMonth() <= 2) ? 11 : 10; // DST for Melbourne
        const melbourneTime = new Date(utcDate.getTime() + melbourneOffset * 60 * 60 * 1000);

        const dayOfWeek = melbourneTime.toLocaleString('en-US', { weekday: 'long' });
        const month = melbourneTime.toLocaleString('en-US', { month: 'long' });
        const year = melbourneTime.getFullYear();
        let day = melbourneTime.getDate();
        const suffixes = ["th", "st", "nd", "rd"];
        const v = day % 100;
        const suffix = suffixes[(v - 20) % 10] || suffixes[v] || suffixes[0];

        const hours = melbourneTime.getHours() % 12 || 12;
        const minutes = melbourneTime.getMinutes().toString().padStart(2, '0');
        const seconds = melbourneTime.getSeconds().toString().padStart(2, '0');
        const ampm = melbourneTime.getHours() >= 12 ? 'PM' : 'AM';

        return `${dayOfWeek}, ${month} ${day}${suffix}, ${year} at ${hours}:${minutes}:${seconds} ${ampm}`;
    }

    function appendNewMessages(messages, forceScrollBottom = false) {
        const atBottom = isAtBottom();
        const previousScrollHeight = messagesContainer.scrollHeight;

        let appended = false;

        messages.forEach(message => {
            const msgId = getMessageId(message);
            if (!renderedMessageIds.has(msgId)) {
                renderedMessageIds.add(msgId);
                appended = true;

                const messageContainer = document.createElement('div');
                messageContainer.classList.add('message-container');

                const timestampElement = document.createElement('div');
                timestampElement.classList.add('timestamp');
                timestampElement.textContent = formatDate(message.timestamp);

                const messageElement = document.createElement('div');
                messageElement.classList.add('message', message.username === currentUser ? 'sent' : 'received');

                if (message.image_url) {
                    messageElement.innerHTML = `<span class="username">${message.username} ${message.emoji}</span>:<br>
                        <img src="${message.image_url}" class="chat-image" alt="sent image" onclick="showFullscreenImage('${message.image_url.replace(/'/g, "\\'")}')">`;
                } else {
                    messageElement.innerHTML = `<span class="username">${message.username} ${message.emoji}</span>: <span class="text">${message.message}</span>`;
                }

                messageContainer.appendChild(timestampElement);
                messageContainer.appendChild(messageElement);
                messagesContainer.appendChild(messageContainer);
            }
        });

        if (appended && !atBottom && !forceScrollBottom) {
            newMessageIndicator.style.display = 'block';
        }

        if (forceScrollBottom || (atBottom && appended)) {
            scrollToBottom();
            newMessageIndicator.style.display = 'none';
        } else if (appended) {
            const newScrollHeight = messagesContainer.scrollHeight;
            messagesContainer.scrollTop += (newScrollHeight - previousScrollHeight);
        }
    }

    function clearMessages() {
        messagesContainer.innerHTML = '';
        renderedMessageIds = new Set();
    }

    clearMessages();

    setInterval(fetchMessages, 3000);

    document.getElementById('sendMessageForm').addEventListener('submit', async (event) => {
        event.preventDefault();
        const messageInput = document.getElementById('messageInput');
        if (messageInput.value.trim() === '') return;

        try {
            const response = await fetch(`/chat_room/${key}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ message: messageInput.value })
            });

            if (response.ok) {
                messageInput.value = '';
                fetchMessages(true);
            } else {
                const data = await response.json();
                console.error("Error sending message:", data.error || response.status);
            }
        } catch (error) {
            console.error("Fetch error:", error);
        }
    });

    function uploadImage(event, groupCode) {
        const file = event.target.files[0];
        if (!file) return;
        const formData = new FormData();
        formData.append('image', file);

        fetch(`/IMAGES/${groupCode}/`, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data && data.image_url) {
                fetch(`/chat_room/${groupCode}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: '',
                        image_url: data.image_url
                    })
                }).then(() => {
                    fetchMessages(true);
                });
            } else {
                alert('Photo upload failed.');
            }
        })
        .catch(error => {
            alert('Photo upload failed.');
        });
        event.target.value = "";
    }

    newMessageIndicator.addEventListener('click', function() {
        scrollToBottom();
        this.style.display = 'none';
    });

    messagesContainer.addEventListener('scroll', function() {
        if (isAtBottom()) {
            newMessageIndicator.style.display = 'none';
        }
    });

    function showFullscreenImage(src) {
        const modal = document.getElementById('fullscreenImageModal');
        const img = document.getElementById('fullscreenImage');
        img.src = src;
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
    }
    function closeFullscreenImage() {
        document.getElementById('fullscreenImageModal').style.display = 'none';
        document.body.style.overflow = '';
    }
    document.getElementById('fullscreenImageModal').addEventListener('click', function(e) {
        if (e.target === this) closeFullscreenImage();
    });


    // --- To-Do List logic ---
    // Only initialize and run if not 'cassie_user'
    if (currentUser !== 'cassie_user') {
        let todoList = [];
        const newTodo = document.getElementById('new-todo');
        const addBtn = document.getElementById('add-todo-btn');
        const editBtn = document.getElementById('edit-todo-btn');
        const saveBtn = document.getElementById('save-todo-btn');
        const editArea = document.getElementById('edit-todo-area');
        const todoDiv = document.getElementById('todo-list');

        function renderTodoList(list) {
            const container = document.getElementById('todo-list');
            container.innerHTML = '';
            list.forEach((item, idx) => {
                const div = document.createElement('div');
                div.className = "d-flex align-items-center mb-1";
                div.innerHTML = `
                    <input type="checkbox" ${item.done ? "checked" : ""} style="margin-right:8px;" data-idx="${idx}">
                    <span style="flex:1;${item.done?"text-decoration:line-through; color:#888;":""}">${item.text}</span>
                    <button class="btn btn-danger btn-sm ms-2" data-remove-idx="${idx}" title="Delete">üóëÔ∏è</button>
                `;
                container.appendChild(div);
            });
        }

        async function loadTodoList() {
            const res = await fetch('/todo');
            const list = await res.json();
            renderTodoList(list);
        }
        async function saveTodoList(list) {
            await fetch('/todo', {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({todo: list})
            });
        }

        document.addEventListener("DOMContentLoaded", () => {
            function refresh() {
                loadTodoList().then(() => {
                    fetch('/todo').then(r=>r.json()).then(list => todoList = list);
                });
            }
            refresh();

            addBtn.onclick = async () => {
                if(newTodo.value.trim()) {
                    todoList.push({text: newTodo.value.trim(), done: false});
                    await saveTodoList(todoList);
                    newTodo.value = "";
                    refresh();
                }
            };
            todoDiv.onclick = async (e) => {
                if(e.target.matches('input[type=checkbox]')) {
                    const idx = +e.target.dataset.idx;
                    todoList[idx].done = e.target.checked;
                    await saveTodoList(todoList);
                    refresh();
                } else if(e.target.dataset.removeIdx !== undefined) {
                    const idx = +e.target.dataset.removeIdx;
                    todoList.splice(idx,1);
                    await saveTodoList(todoList);
                    refresh();
                }
            };
            editBtn.onclick = () => {
                editArea.value = todoList.map(t => (t.done?"[x] ":"[ ] ") + t.text).join("\n");
                editArea.style.display = saveBtn.style.display = "block";
                editBtn.style.display = "none";
            };
            saveBtn.onclick = async () => {
                // Parse lines: [x] or [ ] at start
                todoList = editArea.value.split(/\n/).filter(Boolean).map(line => {
                    let done = /^\s*\[x\]/i.test(line);
                    let text = line.replace(/^\s*\[[x ]\]\s*/i,"");
                    return {text, done};
                });
                await saveTodoList(todoList);
                editArea.style.display = saveBtn.style.display = "none";
                editBtn.style.display = "inline-block";
                refresh();
            };
        });
    }


    // --- Notes logic ---
    // Only initialize and run if not 'cassie_user'
    if (currentUser !== 'cassie_user') {
        const notesArea = document.getElementById('notes-area');
        const saveNotesBtn = document.getElementById('save-notes-btn');
        const notesStatus = document.getElementById('notes-status');

        async function loadNotes() {
            const res = await fetch('/notes');
            const notes = await res.json();
            notesArea.value = typeof notes === "string" ? notes : (Array.isArray(notes) ? notes.join('\n') : "");
        }
        loadNotes();

        saveNotesBtn.onclick = async () => {
            const notes = notesArea.value;
            notesStatus.textContent = "Saving...";
            await fetch('/notes', {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({notes: notes})
            });
            notesStatus.textContent = "Saved!";
            setTimeout(() => notesStatus.textContent = "", 1500);
        };
    }

    // --- Image Submission/Feedback Logic ---
    if (currentUser === 'cassie_user') {
        const imageSubmissionForm = document.getElementById('imageSubmissionForm');
        const imageUploadInput = document.getElementById('imageUpload');
        const imageDescriptionInput = document.getElementById('imageDescription');
        const imageSubmitStatus = document.getElementById('imageSubmitStatus');
        const cassiePreviousSubmissionsDiv = document.getElementById('cassiePreviousSubmissions');

        imageSubmissionForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            
            const file = imageUploadInput.files[0];
            const description = imageDescriptionInput.value.trim();

            if (!file || !description) {
                imageSubmitStatus.textContent = "Please select an image and provide a description.";
                imageSubmitStatus.style.color = "red";
                return;
            }

            imageSubmitStatus.textContent = "Uploading and submitting...";
            imageSubmitStatus.style.color = "blue";

            const formData = new FormData();
            formData.append('image', file);
            formData.append('description', description);

            try {
                const response = await fetch('/submit_image', {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();

                if (response.ok) {
                    imageSubmitStatus.textContent = data.message;
                    imageSubmitStatus.style.color = "green";
                    imageUploadInput.value = ''; // Clear file input
                    imageDescriptionInput.value = ''; // Clear description
                    fetchImageSubmissionsForCassie(); // Refresh list
                } else {
                    imageSubmitStatus.textContent = `Error: ${data.error || 'Unknown error'}`;
                    imageSubmitStatus.style.color = "red";
                }
            } catch (error) {
                imageSubmitStatus.textContent = `Network error: ${error.message}`;
                imageSubmitStatus.style.color = "red";
                console.error("Image submission fetch error:", error);
            }
            setTimeout(() => imageSubmitStatus.style.display = 'none', 5000); // Hide status after a delay
            imageSubmitStatus.style.display = 'block';
        });

        async function fetchImageSubmissionsForCassie() {
            try {
                const response = await fetch('/get_image_submissions');
                const data = await response.json();
                if (response.ok && data.submissions) {
                    renderCassieSubmissions(data.submissions);
                } else {
                    console.error("Error fetching Cassie's submissions:", data.error || response.status);
                    cassiePreviousSubmissionsDiv.innerHTML = '<p class="text-danger">Failed to load submissions.</p>';
                }
            } catch (error) {
                console.error("Fetch error for Cassie's submissions:", error);
                cassiePreviousSubmissionsDiv.innerHTML = '<p class="text-danger">Network error loading submissions.</p>';
            }
        }

        function renderCassieSubmissions(submissions) {
            cassiePreviousSubmissionsDiv.innerHTML = '';
            if (submissions.length === 0) {
                cassiePreviousSubmissionsDiv.innerHTML = '<p class="text-muted">No submissions yet.</p>';
                return;
            }
            submissions.forEach(submission => {
                const submissionDiv = document.createElement('div');
                submissionDiv.classList.add('list-group-item', 'submission-item');
                submissionDiv.innerHTML = `
                    <p class="mb-1"><strong>Description:</strong> ${submission.description}</p>
                    <img src="${submission.image_url}" alt="Submission Image" class="img-fluid mb-2 chat-image" onclick="showFullscreenImage('${submission.image_url.replace(/'/g, "\\'")}')">
                    <small class="text-muted d-block mb-2">Submitted: ${formatDate(submission.timestamp)}</small>
                    <div class="submission-feedback">
                        <strong>Feedback:</strong><br>
                        H: ${submission.feedback.h || 'No feedback yet.'}<br>
                        Olivia: ${submission.feedback.olivia || 'No feedback yet.'}
                    </div>
                `;
                cassiePreviousSubmissionsDiv.appendChild(submissionDiv);
            });
        }
        fetchImageSubmissionsForCassie(); // Initial load
        setInterval(fetchImageSubmissionsForCassie, 10000); // Refresh every 10 seconds
    } 
    
    else if (currentUser === 'h' || currentUser === 'olivia') {
        const currentImageDetailsDiv = document.getElementById('currentImageDetails');
        const feedbackArea = document.getElementById('feedbackArea');
        const submitFeedbackBtn = document.getElementById('submitFeedbackBtn');
        const feedbackStatusSpan = document.getElementById('feedbackStatus');
        const previousImageSubmissionsDiv = document.getElementById('previousImageSubmissions');

        let currentSubmissionId = null;

        submitFeedbackBtn.addEventListener('click', async () => {
            if (!currentSubmissionId) {
                feedbackStatusSpan.textContent = "No current submission to provide feedback for.";
                feedbackStatusSpan.style.color = "red";
                return;
            }
            const feedbackText = feedbackArea.value.trim();
            if (!feedbackText) {
                feedbackStatusSpan.textContent = "Feedback cannot be empty.";
                feedbackStatusSpan.style.color = "red";
                return;
            }

            feedbackStatusSpan.textContent = "Submitting feedback...";
            feedbackStatusSpan.style.color = "blue";

            try {
                const response = await fetch(`/submit_feedback/${currentSubmissionId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ feedback: feedbackText })
                });
                const data = await response.json();

                if (response.ok) {
                    feedbackStatusSpan.textContent = data.message;
                    feedbackStatusSpan.style.color = "green";
                    fetchImageSubmissions(); // Refresh all submissions
                } else {
                    feedbackStatusSpan.textContent = `Error: ${data.error || 'Unknown error'}`;
                    feedbackStatusSpan.style.color = "red";
                }
            } catch (error) {
                feedbackStatusSpan.textContent = `Network error: ${error.message}`;
                feedbackStatusSpan.style.color = "red";
                console.error("Feedback submission fetch error:", error);
            }
            setTimeout(() => feedbackStatusSpan.textContent = "", 5000); // Hide status after a delay
        });

        async function fetchImageSubmissions() {
            try {
                const response = await fetch('/get_image_submissions');
                const data = await response.json();
                if (response.ok && data.submissions) {
                    renderImageSubmissions(data.submissions);
                } else {
                    console.error("Error fetching image submissions:", data.error || response.status);
                    currentImageDetailsDiv.innerHTML = '<p class="text-danger">Failed to load submissions.</p>';
                    previousImageSubmissionsDiv.innerHTML = '';
                }
            } catch (error) {
                console.error("Fetch error for image submissions:", error);
                currentImageDetailsDiv.innerHTML = '<p class="text-danger">Network error loading submissions.</p>';
                previousImageSubmissionsDiv.innerHTML = '';
            }
        }

        function renderImageSubmissions(submissions) {
            currentImageDetailsDiv.innerHTML = '';
            previousImageSubmissionsDiv.innerHTML = '';

            if (submissions.length === 0) {
                currentImageDetailsDiv.innerHTML = '<p class="text-muted">No submissions yet.</p>';
                previousImageSubmissionsDiv.innerHTML = '<p class="text-muted">No previous submissions.</p>';
                currentSubmissionId = null;
                feedbackArea.value = '';
                feedbackArea.disabled = true;
                submitFeedbackBtn.disabled = true;
                return;
            }

            // The "current" submission is the latest one
            const currentSubmission = submissions[0];
            currentSubmissionId = currentSubmission.id;
            feedbackArea.disabled = false;
            submitFeedbackBtn.disabled = false;

            // Store current feedback area value and focus state
            const currentFeedbackValue = feedbackArea.value;
            const hasFeedbackFocus = (document.activeElement === feedbackArea);

            currentImageDetailsDiv.innerHTML = `
                <div class="submission-item">
                    <p class="mb-1"><strong>Description:</strong> ${currentSubmission.description}</p>
                    <img src="${currentSubmission.image_url}" alt="Current Submission Image" class="img-fluid mb-2 chat-image" onclick="showFullscreenImage('${currentSubmission.image_url.replace(/'/g, "\\'")}')">
                    <small class="text-muted d-block mb-2">Submitted by ${currentSubmission.uploader} on ${formatDate(currentSubmission.timestamp)}</small>
                    <div class="submission-feedback">
                        H's Feedback: ${currentSubmission.feedback.h || 'No feedback yet.'}<br>
                        Olivia's Feedback: ${currentSubmission.feedback.olivia || 'No feedback yet.'}
                    </div>
                </div>
            `;
            // Only pre-fill feedback area if it doesn't have focus or its content hasn't changed
            if (!hasFeedbackFocus) {
                feedbackArea.value = currentSubmission.feedback[currentUser] || '';
            }


            // Render previous submissions (all except the current one)
            if (submissions.length > 1) {
                submissions.slice(1).forEach(submission => {
                    const submissionDiv = document.createElement('div');
                    submissionDiv.classList.add('list-group-item', 'submission-item');
                    submissionDiv.innerHTML = `
                        <p class="mb-1"><strong>Description:</strong> ${submission.description}</p>
                        <img src="${submission.image_url}" alt="Previous Submission Image" class="img-fluid mb-2 chat-image" onclick="showFullscreenImage('${submission.image_url.replace(/'/g, "\\'")}')">
                        <small class="text-muted d-block mb-2">Submitted by ${submission.uploader} on ${formatDate(submission.timestamp)}</small>
                        <div class="submission-feedback">
                            H's Feedback: ${submission.feedback.h || 'No feedback yet.'}<br>
                            Olivia's Feedback: ${submission.feedback.olivia || 'No feedback yet.'}
                        </div>
                    `;
                    previousImageSubmissionsDiv.appendChild(submissionDiv);
                });
            } else {
                previousImageSubmissionsDiv.innerHTML = '<p class="text-muted">No previous submissions.</p>';
            }
        }
        fetchImageSubmissions(); // Initial load
        setInterval(fetchImageSubmissions, 10000); // Refresh every 10 seconds
    }
</script>
{% endblock %}
