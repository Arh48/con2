<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Game Boy Emulator</title>
  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
    }
    body {
      background: #222;
      color: #eee;
      font-family: sans-serif;
      text-align: center;
      overscroll-behavior-y: contain;
    }
    #gb {
      display: block;
      margin: 2em auto;
      border: 4px solid #555;
      background: #000;
      image-rendering: pixelated;
      width: 480px;
      height: 432px;
    }
    #controls {
      margin: 1.5em 0;
    }
    input[type="file"], select, button {
      color: #eee;
      background: #444;
      border: 1px solid #555;
      padding: 0.25em;
      margin: 0.25em;
    }
    #status {
      margin-top: 1em;
      color: #9f9;
      font-size: 1.1em;
    }
    
    /* --- Mobile On-Screen Controls --- */
    #mobile-controls {
      display: none;
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 30vh;
      background: rgba(40, 40, 40, 0.85);
      padding: 15px;
      box-sizing: border-box;
      user-select: none;
      -webkit-user-select: none;
      -webkit-tap-highlight-color: transparent;
      align-items: center;
      justify-content: space-between;
    }

    .dpad {
      position: relative;
      width: 130px;
      height: 130px;
    }

    .dpad-btn {
      position: absolute;
      width: 44px;
      height: 44px;
      background: #555;
      border: 1px solid #777;
      color: #eee;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 20px;
      border-radius: 4px;
    }
    #btn-up { top: 0; left: 43px; }
    #btn-left { top: 43px; left: 0; }
    #btn-right { top: 43px; left: 86px; }
    #btn-down { top: 86px; left: 43px; }

    .ab-buttons {
      display: flex;
      gap: 25px;
      align-items: center;
    }

    .ab-btn {
      width: 65px;
      height: 65px;
      background: #902050;
      border: 2px solid #601030;
      border-radius: 50%;
      color: white;
      font-weight: bold;
      font-family: sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 22px;
    }

    .start-select {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      bottom: 10px;
      display: flex;
      gap: 15px;
    }

    .ss-btn {
      background: #3a3a3a;
      border: 1px solid #555;
      color: #ccc;
      padding: 6px 12px;
      border-radius: 10px;
      font-size: 12px;
    }
    
    .dpad-btn:active, .ab-btn:active, .ss-btn:active {
      background-color: #eee;
      color: #222;
    }

    /* Media Query to show controls on mobile screens */
    @media (max-width: 768px) {
      body {
        display: flex;
        flex-direction: column;
      }
      #mobile-controls {
        display: flex;
        order: 3;
        position: relative;
        height: auto;
        min-height: 140px;
      }
      #gb {
        order: 2;
        width: 100%;
        margin: 0;
        border: none;
        flex-grow: 1;
        object-fit: contain;
        min-height: 0;
      }
      #controls {
        order: 1;
        margin: 0;
        padding: 10px;
        background: #333;
        flex-shrink: 0;
      }
      h1, #status {
        display: none;
      }
    }
  </style>
</head>
<body>
  <h1>Game Boy Emulator</h1>
  <div id="controls">
    <p>Upload a ROM, drag and drop, or choose from your server's library:</p>
    <input type="file" id="romInput" accept=".gb,.gbc" />
    <input type="file" id="savInput" accept=".sav,.sa2" /> <select id="serverRomSelect">
      <option value="">-- Choose ROM from Server --</option>
    </select>
    
    <button id="startBtn" disabled>Start</button>
    <button id="saveBtn" style="display:none;">Save Game</button>
  </div>
  <canvas id="gb" width="160" height="144"></canvas>
  <div id="status"></div>
  
  <div id="mobile-controls">
    <div class="dpad">
      <div id="btn-up" class="dpad-btn">▲</div>
      <div id="btn-left" class="dpad-btn">◄</div>
      <div id="btn-right" class="dpad-btn">►</div>
      <div id="btn-down" class="dpad-btn">▼</div>
    </div>
    <div class="start-select">
      <div id="btn-select" class="ss-btn">SELECT</div>
      <div id="btn-start"  class="ss-btn">START</div>
    </div>
    <div class="ab-buttons">
      <div id="btn-b" class="ab-btn">B</div>
      <div id="btn-a" class="ab-btn">A</div>
    </div>
  </div>

  <script src="static/gb.js"></script>
  <script>
    let gb = new GameBoy();
    let romFile = null;
    let savFile = null;

    const romInput = document.getElementById('romInput');
    const savInput = document.getElementById('savInput');
    const startBtn = document.getElementById('startBtn');
    const saveBtn = document.getElementById('saveBtn');
    const status = document.getElementById('status');
    const serverRomSelect = document.getElementById('serverRomSelect');
    
    // Function to update the start button's disabled state
    function updateStartButtonState() {
        startBtn.disabled = !romFile;
    }

    // Function to update the status text
    function updateStatusText() {
        let text = "";
        if (romFile) {
            text += `Loaded ROM: ${romFile.name}`;
        } else {
            text += "Please select a ROM or upload one.";
        }
        if (savFile) {
            text += ` | Save: ${savFile.name}`;
        }
        status.textContent = text;
    }

    // Function to fetch ROM list from server and populate the dropdown
    async function fetchServerRoms() {
      try {
        const response = await fetch('/api/list-roms');
        if (!response.ok) throw new Error("Could not fetch server ROM list.");
        const roms = await response.json();
        
        roms.forEach(rom => {
          const option = document.createElement('option');
          option.value = rom;
          option.textContent = rom;
          serverRomSelect.appendChild(option);
        });
      } catch (error) {
        console.error("Error fetching ROMs:", error);
        const option = document.createElement('option');
        option.textContent = "Error loading ROMs";
        serverRomSelect.appendChild(option);
        serverRomSelect.disabled = true;
      }
    }

    // Call this function when the page loads
    window.addEventListener('load', () => {
        fetchServerRoms();
        updateStatusText(); // Initial status text
        updateStartButtonState();
    });

    // Event listener for when a ROM file is uploaded
    romInput.addEventListener('change', () => {
      romFile = romInput.files[0];
      serverRomSelect.value = ""; // Clear server selection
      updateStatusText();
      updateStartButtonState();
      saveBtn.style.display = 'none'; // Hide save button until game starts
    });
    
    // Event listener for when a save file is uploaded
    savInput.addEventListener('change', () => {
      savFile = savInput.files[0];
      updateStatusText();
    });

    // Event listener for when a server ROM is selected
    serverRomSelect.addEventListener('change', async () => {
      const selectedRomName = serverRomSelect.value;
      if (selectedRomName) {
        status.textContent = `Loading server ROM: ${selectedRomName}`;
        startBtn.disabled = true; // Disable start button while fetching
        romInput.value = ""; // Clear local ROM file input
        saveBtn.style.display = 'none'; // Hide save button

        try {
          // Fetch the ROM file from the server
          const response = await fetch(`/roms/${selectedRomName}`);
          if (!response.ok) throw new Error(`Failed to fetch ROM: ${response.statusText}`);
          
          const romBlob = await response.blob();
          // Create a File object from the blob to use with the emulator
          romFile = new File([romBlob], selectedRomName);
          updateStatusText();
          updateStartButtonState();
        } catch (error) {
          status.textContent = `Error loading ROM: ${error.message}`;
          romFile = null;
          updateStartButtonState(); // Ensure button is disabled on error
        }
      } else {
        romFile = null;
        updateStatusText();
        updateStartButtonState();
      }
    });

    startBtn.addEventListener('click', async () => {
      if (!romFile) return;
      startBtn.disabled = true;
      status.textContent = "Loading and starting emulator...";

      const romBuf = await romFile.arrayBuffer();
      let savBuf;
      if (savFile) {
        savBuf = await savFile.arrayBuffer();
      } else {
        // Provide an empty save buffer if no local save file is selected
        savBuf = new Uint8Array(32 * 1024).buffer; // Common Game Boy save size
      }

      try {
        await gb.start({
          wasmPath: "static/gb.wasm",
          canvasId: "gb",
          rom: romBuf,
          sav: savBuf
        });

        status.textContent = `Running: ${romFile.name}` + (savFile ? ` with save: ${savFile.name}` : '');
        saveBtn.style.display = 'inline-block';
      } catch (error) {
        status.textContent = `Error starting emulator: ${error.message}`;
        console.error("Emulator start error:", error);
        startBtn.disabled = false; // Re-enable start button on error
      }
    });

    saveBtn.addEventListener('click', () => {
      if (romFile) {
        const saveName = romFile.name.substring(0, romFile.name.lastIndexOf('.')) + ".sav";
        gb.save(saveName);
      } else {
        alert("No ROM loaded to save game for.");
      }
    });

    // Drag-and-drop support
    document.addEventListener('dragover', e => e.preventDefault());
    document.addEventListener('drop', async e => {
      e.preventDefault();
      const files = [...e.dataTransfer.files];
      let rom = files.find(f => /\.gbc?$/.test(f.name));
      let sav = files.find(f => /\.sav$|\.sa2$/.test(f.name));
      
      if (rom) {
        romFile = rom;
        romInput.value = ""; // Clear local ROM input
        serverRomSelect.value = ""; // Clear server selection
      }
      if (sav) {
        savFile = sav;
        savInput.value = ""; // Clear local SAV input (though not strictly necessary as savFile is set)
      }

      updateStatusText();
      updateStartButtonState();
      
      if (romFile) {
        await startBtn.click(); // Automatically start if a ROM is dropped
      }
    });
    
    // --- Mobile Controls Event Listeners ---
    const mobileControls = {
      'btn-up':     { press: () => gb.wasm.instance.exports.press_up(),    release: () => gb.wasm.instance.exports.release_up() },
      'btn-down':   { press: () => gb.wasm.instance.exports.press_down(),  release: () => gb.wasm.instance.exports.release_down() },
      'btn-left':   { press: () => gb.wasm.instance.exports.press_left(),  release: () => gb.wasm.instance.exports.release_left() },
      'btn-right':  { press: () => gb.wasm.instance.exports.press_right(), release: () => gb.wasm.instance.exports.release_right() },
      'btn-a':      { press: () => gb.wasm.instance.exports.press_a(),     release: () => gb.wasm.instance.exports.release_a() },
      'btn-b':      { press: () => gb.wasm.instance.exports.press_b(),     release: () => gb.wasm.instance.exports.release_b() },
      'btn-start':  { press: () => gb.wasm.instance.exports.press_start(), release: () => gb.wasm.instance.exports.release_start() },
      'btn-select': { press: () => gb.wasm.instance.exports.press_select(), release: () => gb.wasm.instance.exports.release_select() }
    };

    for (const [id, actions] of Object.entries(mobileControls)) {
        const button = document.getElementById(id);
        if (button) {
            const press = (e) => { e.preventDefault(); if(gb.wasm) actions.press(); };
            const release = (e) => { e.preventDefault(); if(gb.wasm) actions.release(); };
            
            button.addEventListener('touchstart', press, { passive: false });
            button.addEventListener('touchend', release, { passive: false });
            button.addEventListener('mousedown', press, { passive: false });
            button.addEventListener('mouseup', release, { passive: false });
            button.addEventListener('mouseleave', release, { passive: false });
        }
    }
  </script>
</body>
</html>